/*
 * To change this template, choose Tools | Templates
 * and open the template in the editor.
 */

/*
 * GraphExplorerMain.java
 *
 * Created on May 14, 2010, 10:10:30 AM
 */

package graphexplorer;

import data.propertysheet.editor.EditorRegistration;
import java.util.logging.Level;
import java.util.logging.Logger;
import javax.swing.DefaultComboBoxModel;
import javax.swing.UIManager;
import javax.swing.event.TableModelEvent;
import javax.swing.text.BadLocationException;
import javax.swing.text.Document;
import org.bm.blaise.scio.graph.Graph;
import org.bm.blaise.scio.graph.layout.EnergyLayout;
import org.bm.blaise.specto.plane.graph.PlaneGraph;
import org.jfree.chart.ChartFactory;
import org.jfree.chart.ChartPanel;
import org.jfree.chart.JFreeChart;
import org.jfree.chart.plot.PlotOrientation;
import org.jfree.data.xy.DefaultXYDataset;
import org.jfree.data.xy.XYBarDataset;
import visometry.plane.PlanePlotComponent;
import visometry.plottable.Plottable;

/**
 *
 * @author ae3263
 */
public class GraphExplorerMain extends javax.swing.JFrame {

    /** Singleton describing actions that can be taken within this app */
    GraphExplorerActions actions;
    /** Tracks the active graph in the explorer */
    PlaneGraph activeGraph;
    /** Layout engine that may animate */
    EnergyLayout energy;

    /** Chart displaying statistical data */
    ChartPanel distributionCP;

    /** Creates new form GraphExplorerMain */
    public GraphExplorerMain() {
        try { UIManager.setLookAndFeel(UIManager.getSystemLookAndFeelClassName()); } catch (Exception e) { }
        EditorRegistration.registerEditors();
        actions = new GraphExplorerActions(this);
        initComponents();

        JFreeChart distributionFC = ChartFactory.createXYBarChart("Metric Distribution", "Value", false, "Number", null, PlotOrientation.VERTICAL, false, true, false);
        distributionSP.setTopComponent(distributionCP = new ChartPanel(distributionFC));
    }

    /** This method is called from within the constructor to
     * initialize the form.
     * WARNING: Do NOT modify this code. The content of this method is
     * always regenerated by the Form Editor.
     */
    @SuppressWarnings("unchecked")
    // <editor-fold defaultstate="collapsed" desc="Generated Code">//GEN-BEGIN:initComponents
    private void initComponents() {

        vertexTM = new graphexplorer.GraphTableModel();
        metricTM = new graphexplorer.MetricTableModel();
        jScrollPane2 = new javax.swing.JScrollPane();
        outputTP = new javax.swing.JTextPane();
        jTabbedPane1 = new javax.swing.JTabbedPane();
        graphSP = new javax.swing.JSplitPane();
        jScrollPane3 = new javax.swing.JScrollPane();
        vertexTable = new javax.swing.JTable();
        adjacencyP = new javax.swing.JPanel();
        jLabel1 = new javax.swing.JLabel();
        distributionP = new javax.swing.JPanel();
        distributionTB = new javax.swing.JToolBar();
        jLabel2 = new javax.swing.JLabel();
        metricCB = new javax.swing.JComboBox();
        distributionSP = new javax.swing.JSplitPane();
        jScrollPane4 = new javax.swing.JScrollPane();
        distributionTable = new javax.swing.JTable();
        metricSP = new javax.swing.JSplitPane();
        jScrollPane5 = new javax.swing.JScrollPane();
        metricTable = new javax.swing.JTable();
        graphTP = new javax.swing.JTabbedPane();
        jScrollPane1 = new javax.swing.JScrollPane();
        propertyRP = new gui.RollupPanel();
        jToolBar1 = new javax.swing.JToolBar();
        jButton1 = new javax.swing.JButton();
        jButton2 = new javax.swing.JButton();
        jMenuBar1 = new javax.swing.JMenuBar();
        fileM = new javax.swing.JMenu();
        loadMI = new javax.swing.JMenuItem();
        saveMI = new javax.swing.JMenuItem();
        closeMI = new javax.swing.JMenuItem();
        quitMI = new javax.swing.JMenuItem();
        createM = new javax.swing.JMenu();
        emptyMI = new javax.swing.JMenuItem();
        circleMI = new javax.swing.JMenuItem();
        starMI = new javax.swing.JMenuItem();
        wheelMI = new javax.swing.JMenuItem();
        completeMI = new javax.swing.JMenuItem();
        jSeparator1 = new javax.swing.JPopupMenu.Separator();
        uniform1MI = new javax.swing.JMenuItem();
        uniform2MI = new javax.swing.JMenuItem();
        preferentialMI = new javax.swing.JMenuItem();
        jMenuItem3 = new javax.swing.JMenuItem();
        layoutM = new javax.swing.JMenu();
        circularMI = new javax.swing.JMenuItem();
        randomMI = new javax.swing.JMenuItem();
        energyM = new javax.swing.JMenu();
        energyStartMI = new javax.swing.JMenuItem();
        energyStopMI = new javax.swing.JMenuItem();
        energyIterateMI = new javax.swing.JMenuItem();
        distributionM = new javax.swing.JMenu();
        distDegreeMI = new javax.swing.JMenuItem();
        distDegree2MI = new javax.swing.JMenuItem();
        distCliqueMI = new javax.swing.JMenuItem();
        distClique2MI = new javax.swing.JMenuItem();
        distDecay25MI = new javax.swing.JMenuItem();
        distDecay50MI = new javax.swing.JMenuItem();
        distDecay75MI = new javax.swing.JMenuItem();
        distDecayCustomMI = new javax.swing.JMenuItem();
        jSeparator2 = new javax.swing.JPopupMenu.Separator();
        distSummaryMI = new javax.swing.JMenuItem();
        helpM = new javax.swing.JMenu();
        aboutMI = new javax.swing.JMenuItem();
        contentMI = new javax.swing.JMenuItem();

        vertexTM.addTableModelListener(new javax.swing.event.TableModelListener() {
            public void tableChanged(javax.swing.event.TableModelEvent evt) {
                vertexTMTableChanged(evt);
            }
        });

        setDefaultCloseOperation(javax.swing.WindowConstants.EXIT_ON_CLOSE);
        setTitle("Graph Explorer");

        outputTP.setBackground(new java.awt.Color(0, 0, 0));
        outputTP.setForeground(new java.awt.Color(204, 204, 255));
        outputTP.setText("== Output ==\n");
        outputTP.setPreferredSize(new java.awt.Dimension(500, 200));
        jScrollPane2.setViewportView(outputTP);

        getContentPane().add(jScrollPane2, java.awt.BorderLayout.PAGE_END);

        jTabbedPane1.setTabLayoutPolicy(javax.swing.JTabbedPane.SCROLL_TAB_LAYOUT);
        jTabbedPane1.setPreferredSize(new java.awt.Dimension(300, 400));

        graphSP.setDividerLocation(200);
        graphSP.setOrientation(javax.swing.JSplitPane.VERTICAL_SPLIT);

        vertexTable.setModel(vertexTM);
        jScrollPane3.setViewportView(vertexTable);

        graphSP.setLeftComponent(jScrollPane3);

        adjacencyP.setLayout(new java.awt.BorderLayout());

        jLabel1.setText("...adjacency matrix display...");
        adjacencyP.add(jLabel1, java.awt.BorderLayout.CENTER);

        graphSP.setRightComponent(adjacencyP);

        jTabbedPane1.addTab("Vertices & Adjacencies", graphSP);

        distributionP.setLayout(new java.awt.BorderLayout());

        distributionTB.setFloatable(false);
        distributionTB.setRollover(true);

        jLabel2.setText("Metric: ");
        distributionTB.add(jLabel2);

        metricCB.setModel(new DefaultComboBoxModel(GraphExplorerActions.StatEnum.values()));
        metricCB.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                metricCBActionPerformed(evt);
            }
        });
        distributionTB.add(metricCB);

        distributionP.add(distributionTB, java.awt.BorderLayout.PAGE_START);

        distributionSP.setDividerLocation(200);
        distributionSP.setOrientation(javax.swing.JSplitPane.VERTICAL_SPLIT);
        distributionSP.setResizeWeight(0.5);

        distributionTable.setModel(new javax.swing.table.DefaultTableModel(
            new Object [][] {

            },
            new String [] {

            }
        ));
        jScrollPane4.setViewportView(distributionTable);

        distributionSP.setRightComponent(jScrollPane4);

        distributionP.add(distributionSP, java.awt.BorderLayout.CENTER);

        jTabbedPane1.addTab("Distribution", distributionP);

        metricSP.setOrientation(javax.swing.JSplitPane.VERTICAL_SPLIT);

        metricTable.setModel(metricTM);
        jScrollPane5.setViewportView(metricTable);

        metricSP.setTopComponent(jScrollPane5);

        jTabbedPane1.addTab("Metrics", metricSP);

        getContentPane().add(jTabbedPane1, java.awt.BorderLayout.EAST);

        graphTP.setPreferredSize(new java.awt.Dimension(500, 500));
        graphTP.addChangeListener(new javax.swing.event.ChangeListener() {
            public void stateChanged(javax.swing.event.ChangeEvent evt) {
                graphTPStateChanged(evt);
            }
        });
        getContentPane().add(graphTP, java.awt.BorderLayout.CENTER);

        jScrollPane1.setPreferredSize(new java.awt.Dimension(200, 400));
        jScrollPane1.setViewportView(propertyRP);

        getContentPane().add(jScrollPane1, java.awt.BorderLayout.WEST);

        jToolBar1.setRollover(true);

        jButton1.setAction(actions.LAYOUT_ENERGY_START);
        jButton1.setText("Energy-PLAY");
        jButton1.setFocusable(false);
        jButton1.setHorizontalTextPosition(javax.swing.SwingConstants.CENTER);
        jButton1.setVerticalTextPosition(javax.swing.SwingConstants.BOTTOM);
        jToolBar1.add(jButton1);

        jButton2.setAction(actions.LAYOUT_ENERGY_STOP);
        jButton2.setText("Energy-STOP");
        jButton2.setFocusable(false);
        jButton2.setHorizontalTextPosition(javax.swing.SwingConstants.CENTER);
        jButton2.setVerticalTextPosition(javax.swing.SwingConstants.BOTTOM);
        jToolBar1.add(jButton2);

        getContentPane().add(jToolBar1, java.awt.BorderLayout.NORTH);

        fileM.setText("File");

        loadMI.setAction(actions.LOAD_ACTION);
        loadMI.setText("Load graph from file");
        fileM.add(loadMI);

        saveMI.setAction(actions.SAVE_ACTION);
        saveMI.setText("Save current graph to file");
        fileM.add(saveMI);

        closeMI.setAction(actions.CLOSE_ACTION);
        closeMI.setText("Close current graph");
        fileM.add(closeMI);

        quitMI.setAction(actions.QUIT_ACTION);
        quitMI.setText("Quit");
        fileM.add(quitMI);

        jMenuBar1.add(fileM);

        createM.setText("Create");

        emptyMI.setAction(actions.GENERATE_EMPTY);
        emptyMI.setText("Empty Graph");
        createM.add(emptyMI);

        circleMI.setAction(actions.GENERATE_CIRCLE);
        circleMI.setText("Circle Graph");
        createM.add(circleMI);

        starMI.setAction(actions.GENERATE_STAR);
        starMI.setText("Star Graph");
        createM.add(starMI);

        wheelMI.setAction(actions.GENERATE_WHEEL);
        wheelMI.setText("Wheel Graph");
        createM.add(wheelMI);

        completeMI.setAction(actions.GENERATE_COMPLETE);
        completeMI.setText("Complete Graph");
        createM.add(completeMI);
        createM.add(jSeparator1);

        uniform1MI.setAction(actions.GENERATE_RANDOM_PROBABILITY);
        uniform1MI.setText("Uniform (by edge probability)");
        createM.add(uniform1MI);

        uniform2MI.setAction(actions.GENERATE_RANDOM_EDGE);
        uniform2MI.setText("Uniform (by number of edges)");
        createM.add(uniform2MI);

        preferentialMI.setAction(actions.GENERATE_PREFERENTIAL);
        preferentialMI.setText("Preferential Attachment");
        createM.add(preferentialMI);

        jMenuItem3.setAction(actions.GENERATE_PREFERENTIAL2);
        jMenuItem3.setText("Preferential Attachment (varied connection #)");
        createM.add(jMenuItem3);

        jMenuBar1.add(createM);

        layoutM.setText("Layout");

        circularMI.setAction(actions.LAYOUT_CIRCULAR);
        circularMI.setText("Circular");
        layoutM.add(circularMI);

        randomMI.setAction(actions.LAYOUT_RANDOM);
        randomMI.setText("Random");
        layoutM.add(randomMI);

        energyM.setText("Energy");

        energyStartMI.setAction(actions.LAYOUT_ENERGY_START);
        energyStartMI.setText("Start");
        energyM.add(energyStartMI);

        energyStopMI.setAction(actions.LAYOUT_ENERGY_STOP);
        energyStopMI.setText("Stop");
        energyM.add(energyStopMI);

        energyIterateMI.setAction(actions.LAYOUT_ENERGY_ITERATE);
        energyIterateMI.setText("Iterate");
        energyM.add(energyIterateMI);

        layoutM.add(energyM);

        jMenuBar1.add(layoutM);

        distributionM.setText("Distributions");

        distDegreeMI.setAction(actions.STAT_DEGREE);
        distDegreeMI.setText("Degree");
        distributionM.add(distDegreeMI);

        distDegree2MI.setAction(actions.STAT_DEGREE2);
        distDegree2MI.setText("2nd Order Degree");
        distributionM.add(distDegree2MI);

        distCliqueMI.setAction(actions.STAT_CLIQUE);
        distCliqueMI.setText("Clique Count");
        distributionM.add(distCliqueMI);

        distClique2MI.setAction(actions.STAT_CLIQUE2);
        distClique2MI.setText("2nd Order Clique Count");
        distributionM.add(distClique2MI);

        distDecay25MI.setAction(actions.STAT_DECAY_25);
        distDecay25MI.setText("Decay Centrality (0.25)");
        distributionM.add(distDecay25MI);

        distDecay50MI.setAction(actions.STAT_DECAY_50);
        distDecay50MI.setText("Decay Centrality (0.50)");
        distributionM.add(distDecay50MI);

        distDecay75MI.setAction(actions.STAT_DECAY_75);
        distDecay75MI.setText("Decay Centrality (0.75)");
        distributionM.add(distDecay75MI);

        distDecayCustomMI.setAction(actions.STAT_DECAY_CUSTOM);
        distDecayCustomMI.setText("Decay Centality (CUSTOM)");
        distributionM.add(distDecayCustomMI);
        distributionM.add(jSeparator2);

        distSummaryMI.setAction(actions.POPULATE_METRIC_TABLE);
        distSummaryMI.setText("Summary Table");
        distributionM.add(distSummaryMI);

        jMenuBar1.add(distributionM);

        helpM.setText("Help");

        aboutMI.setAction(actions.ABOUT_ACTION);
        aboutMI.setText("About");
        helpM.add(aboutMI);

        contentMI.setAction(actions.HELP_ACTION);
        contentMI.setText("Content");
        helpM.add(contentMI);

        jMenuBar1.add(helpM);

        setJMenuBar(jMenuBar1);

        pack();
    }// </editor-fold>//GEN-END:initComponents

    private void graphTPStateChanged(javax.swing.event.ChangeEvent evt) {//GEN-FIRST:event_graphTPStateChanged
        // update active graph based on selected tab
        PlanePlotComponent ppc = (PlanePlotComponent) graphTP.getSelectedComponent();
        if (ppc != null) {
            Plottable[] ps = ppc.getPlottableArray();
            if (ps == null || ps.length == 0)
                activeGraph = null;
            else
                for (Plottable p : ps)
                    if (p instanceof PlaneGraph) {
                        activeGraph = (PlaneGraph) p;
                        break;
                    }
            if (activeGraph != null) {
                Graph graph = activeGraph.getGraph();
                // stop animation of energy layout and set to new parameters
                actions.LAYOUT_ENERGY_STOP.actionPerformed(null);
                if (energy != null)
                    energy.initialize(graph, activeGraph.getPoint());
                vertexTM.setGraph(graph);
                return;
            }
        }
        activeGraph = null;
        if (energy != null)
            energy.setGraph(null);
    }//GEN-LAST:event_graphTPStateChanged

    private void vertexTMTableChanged(javax.swing.event.TableModelEvent evt) {//GEN-FIRST:event_vertexTMTableChanged
        // only look at individual cell updates
        if (evt.getType() == TableModelEvent.UPDATE && evt.getColumn() != TableModelEvent.ALL_COLUMNS && evt.getFirstRow() != TableModelEvent.HEADER_ROW)
            activeGraph.setLabel(evt.getFirstRow(), (String) vertexTM.getValueAt(evt.getFirstRow(), evt.getColumn()));
    }//GEN-LAST:event_vertexTMTableChanged

    private void metricCBActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_metricCBActionPerformed
        if (activeGraph != null)
            ((GraphExplorerActions.StatEnum)metricCB.getSelectedItem()).getAction(actions).actionPerformed(evt);
    }//GEN-LAST:event_metricCBActionPerformed

    /**
    * @param args the command line arguments
    */
    public static void main(String args[]) {
        java.awt.EventQueue.invokeLater(new Runnable() {
        public void run() {
                new GraphExplorerMain().setVisible(true);
            }
        });
    }

    // Variables declaration - do not modify//GEN-BEGIN:variables
    private javax.swing.JMenuItem aboutMI;
    private javax.swing.JPanel adjacencyP;
    private javax.swing.JMenuItem circleMI;
    private javax.swing.JMenuItem circularMI;
    private javax.swing.JMenuItem closeMI;
    private javax.swing.JMenuItem completeMI;
    private javax.swing.JMenuItem contentMI;
    private javax.swing.JMenu createM;
    private javax.swing.JMenuItem distClique2MI;
    private javax.swing.JMenuItem distCliqueMI;
    private javax.swing.JMenuItem distDecay25MI;
    private javax.swing.JMenuItem distDecay50MI;
    private javax.swing.JMenuItem distDecay75MI;
    private javax.swing.JMenuItem distDecayCustomMI;
    private javax.swing.JMenuItem distDegree2MI;
    private javax.swing.JMenuItem distDegreeMI;
    private javax.swing.JMenuItem distSummaryMI;
    private javax.swing.JMenu distributionM;
    private javax.swing.JPanel distributionP;
    private javax.swing.JSplitPane distributionSP;
    private javax.swing.JToolBar distributionTB;
    private javax.swing.JTable distributionTable;
    private javax.swing.JMenuItem emptyMI;
    private javax.swing.JMenuItem energyIterateMI;
    private javax.swing.JMenu energyM;
    private javax.swing.JMenuItem energyStartMI;
    private javax.swing.JMenuItem energyStopMI;
    private javax.swing.JMenu fileM;
    private javax.swing.JSplitPane graphSP;
    private javax.swing.JTabbedPane graphTP;
    private javax.swing.JMenu helpM;
    private javax.swing.JButton jButton1;
    private javax.swing.JButton jButton2;
    private javax.swing.JLabel jLabel1;
    private javax.swing.JLabel jLabel2;
    private javax.swing.JMenuBar jMenuBar1;
    private javax.swing.JMenuItem jMenuItem3;
    private javax.swing.JScrollPane jScrollPane1;
    private javax.swing.JScrollPane jScrollPane2;
    private javax.swing.JScrollPane jScrollPane3;
    private javax.swing.JScrollPane jScrollPane4;
    private javax.swing.JScrollPane jScrollPane5;
    private javax.swing.JPopupMenu.Separator jSeparator1;
    private javax.swing.JPopupMenu.Separator jSeparator2;
    private javax.swing.JTabbedPane jTabbedPane1;
    private javax.swing.JToolBar jToolBar1;
    private javax.swing.JMenu layoutM;
    private javax.swing.JMenuItem loadMI;
    private javax.swing.JComboBox metricCB;
    private javax.swing.JSplitPane metricSP;
    private graphexplorer.MetricTableModel metricTM;
    private javax.swing.JTable metricTable;
    private javax.swing.JTextPane outputTP;
    private javax.swing.JMenuItem preferentialMI;
    private gui.RollupPanel propertyRP;
    private javax.swing.JMenuItem quitMI;
    private javax.swing.JMenuItem randomMI;
    private javax.swing.JMenuItem saveMI;
    private javax.swing.JMenuItem starMI;
    private javax.swing.JMenuItem uniform1MI;
    private javax.swing.JMenuItem uniform2MI;
    private graphexplorer.GraphTableModel vertexTM;
    private javax.swing.JTable vertexTable;
    private javax.swing.JMenuItem wheelMI;
    // End of variables declaration//GEN-END:variables


    /** Adds a message to the output window. */
    void output(String output) {
        Document d = outputTP.getDocument();
        try {
            d.insertString(d.getLength(), output + "\n", null);
        } catch (BadLocationException ex) {
            Logger.getLogger(GraphExplorerMain.class.getName()).log(Level.SEVERE, null, ex);
        }
    }

    /** Loads a graph into the explorer, by creating a new tabbed window that displays it. */
    void loadGraph(Graph sg, String name) {
        PlanePlotComponent ppc = new PlanePlotComponent();
        ppc.add(activeGraph = new PlaneGraph(sg));
        graphTP.add(name, ppc);
        graphTP.setSelectedComponent(ppc);
        if (vertexTM.getGraph() != sg)
            vertexTM.setGraph(sg);
        output("Successfully loaded graph " + name + " with " + sg.edgeNumber() + " vertices and " + sg.edgeNumber() + " edges.");
    }

    /** Closes the active graph */
    void closeActiveGraph() {
        if (actions.timer != null)
            actions.timer.stop();
        graphTP.remove(graphTP.getSelectedComponent());
        if (graphTP.getComponentCount() == 0)
            vertexTM.setGraph(null);
    }

    /**
     * Sets table model for the distribution table. Also updates the displayed chart.
     * @param model the model for the table displaying values; also used for the chart's values
     * @param barWidth width of the bars displayed in the chart
     */
    void setDistributionModel(DistributionTableModel model, String metricName) {
        distributionTable.setModel(model);
        int[] counts = model.counts;

        int nSamples = counts.length;
        double[][] degCounts = new double[2][counts.length];
        for (int i = 0; i < nSamples; i++) {
            degCounts[0][i] = ((Number)model.values[i]).doubleValue();
            degCounts[1][i] = model.counts[i];
        }
        DefaultXYDataset chartData = new DefaultXYDataset();
        chartData.addSeries(metricName + "Counts", degCounts);
        distributionCP.setChart(
                ChartFactory.createXYBarChart(metricName + " Distribution",
                metricName, false,
                "Number of Nodes", new XYBarDataset(chartData, .9),
                PlotOrientation.VERTICAL, false, true, false));

//        int countMax = counts[0];
//        String countStr = "" + counts[0];
//        for (int i = 1; i < counts.length; i++) { countStr += "," + counts[i]; countMax = Math.max(countMax, counts[i]); }
//        String labelStr = "";
//        for (Object o : model.values) { labelStr += o + "|"; }
//        output("http://chart.apis.google.com/chart?cht=bvg&chs=800x300&chxt=x,y"
//                + "&chd=t:" + countStr
//                + "&chds=" + "0," + countMax
//                + "&chxr=" + "1,0," + countMax
//                + "&chxl=0:|" + labelStr
//                + "&chbh=8,0,1"
//                );

    }

    /** Activates the table that displays standard metrics. */
    void activateMetricTable() {
        metricTM.setGraph(activeGraph.getGraph());
    }
}
